name: ğŸ¥ Health Check

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    name: ğŸŒ‰ GitSync-Bridge Health Monitor
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ” Check GitHub Repository
      id: github_check
      run: |
        # æ£€æŸ¥GitHubä»“åº“çŠ¶æ€
        REPO_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.github.com/repos/${{ github.repository }})
        if [ "$REPO_STATUS" = "200" ]; then
          echo "github_status=âœ… æ­£å¸¸" >> $GITHUB_OUTPUT
          echo "github_ok=true" >> $GITHUB_OUTPUT
        else
          echo "github_status=âŒ å¼‚å¸¸ (HTTP $REPO_STATUS)" >> $GITHUB_OUTPUT
          echo "github_ok=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ” Check Gitee Repository
      id: gitee_check
      env:
        GITEE_USERNAME: ${{ vars.GITEE_USERNAME }}
        GITEE_REPO: ${{ vars.GITEE_REPO }}
      run: |
        # æ£€æŸ¥Giteeä»“åº“çŠ¶æ€
        GITEE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://gitee.com/${GITEE_USERNAME}/${GITEE_REPO})
        if [ "$GITEE_STATUS" = "200" ] || [ "$GITEE_STATUS" = "403" ]; then
          echo "gitee_status=âœ… æ­£å¸¸" >> $GITHUB_OUTPUT
          echo "gitee_ok=true" >> $GITHUB_OUTPUT
        else
          echo "gitee_status=âŒ å¼‚å¸¸ (HTTP $GITEE_STATUS)" >> $GITHUB_OUTPUT
          echo "gitee_ok=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ” Check Secrets Configuration
      id: secrets_check
      run: |
        # æ£€æŸ¥å¿…è¦çš„Secretsæ˜¯å¦é…ç½®
        secrets_ok=true
        
        if [ -z "${{ secrets.GITEE_PASSWORD }}" ]; then
          echo "âŒ GITEE_PASSWORD æœªé…ç½®"
          secrets_ok=false
        else
          echo "âœ… GITEE_PASSWORD å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.GITEE_PRIVATE_KEY }}" ]; then
          echo "âš ï¸ GITEE_PRIVATE_KEY æœªé…ç½® (HTTPSæ¨¡å¼ä¸éœ€è¦)"
        else
          echo "âœ… GITEE_PRIVATE_KEY å·²é…ç½®"
        fi
        
        echo "secrets_ok=$secrets_ok" >> $GITHUB_OUTPUT
        
    - name: ğŸ“Š Check Recent Sync Activity
      id: activity_check
      run: |
        # æ£€æŸ¥æœ€è¿‘çš„åŒæ­¥æ´»åŠ¨
        RECENT_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=10" | \
          jq '.workflow_runs[] | select(.name | contains("Sync")) | select(.created_at > (now - 86400 | todate)) | .conclusion' | \
          grep -c "success" || echo "0")
          
        echo "recent_success=$RECENT_RUNS" >> $GITHUB_OUTPUT
        
        if [ "$RECENT_RUNS" -gt 0 ]; then
          echo "activity_status=âœ… æœ€è¿‘24å°æ—¶æœ‰ $RECENT_RUNS æ¬¡æˆåŠŸåŒæ­¥" >> $GITHUB_OUTPUT
          echo "activity_ok=true" >> $GITHUB_OUTPUT
        else
          echo "activity_status=âš ï¸ æœ€è¿‘24å°æ—¶æ— æˆåŠŸåŒæ­¥" >> $GITHUB_OUTPUT
          echo "activity_ok=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ“ Generate Health Report
      run: |
        echo "ğŸŒ‰ GitSync-Bridge å¥åº·æŠ¥å‘Š"
        echo "============================="
        echo "ğŸ•’ æ£€æŸ¥æ—¶é—´: $(date)"
        echo ""
        echo "ğŸ“Š ç³»ç»ŸçŠ¶æ€:"
        echo "â€¢ GitHubä»“åº“: ${{ steps.github_check.outputs.github_status }}"
        echo "â€¢ Giteeä»“åº“: ${{ steps.gitee_check.outputs.gitee_status }}"
        echo "â€¢ é…ç½®çŠ¶æ€: ${{ steps.secrets_check.outputs.secrets_ok && 'âœ… æ­£å¸¸' || 'âŒ å¼‚å¸¸' }}"
        echo "â€¢ åŒæ­¥æ´»åŠ¨: ${{ steps.activity_check.outputs.activity_status }}"
        echo ""
        echo "ğŸ”— å¿«é€Ÿé“¾æ¥:"
        echo "â€¢ GitHub Actions: https://github.com/${{ github.repository }}/actions"
        echo "â€¢ Giteeä»“åº“: https://gitee.com/${{ vars.GITEE_USERNAME }}/${{ vars.GITEE_REPO }}"
        
    - name: ğŸš¨ Create Issue on Health Problem
      if: |
        steps.github_check.outputs.github_ok != 'true' || 
        steps.gitee_check.outputs.gitee_ok != 'true' || 
        steps.secrets_check.outputs.secrets_ok != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const issueTitle = 'ğŸš¨ GitSync-Bridge å¥åº·æ£€æŸ¥å‘ç°é—®é¢˜';
          const issueBody = `## ğŸš¨ å¥åº·æ£€æŸ¥æŠ¥å‘Š
          
          **æ£€æŸ¥æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
          
          ### ğŸ“Š æ£€æŸ¥ç»“æœ
          - **GitHubä»“åº“**: ${{ steps.github_check.outputs.github_status }}
          - **Giteeä»“åº“**: ${{ steps.gitee_check.outputs.gitee_status }}
          - **é…ç½®çŠ¶æ€**: ${{ steps.secrets_check.outputs.secrets_ok && 'âœ… æ­£å¸¸' || 'âŒ é…ç½®å¼‚å¸¸' }}
          - **åŒæ­¥æ´»åŠ¨**: ${{ steps.activity_check.outputs.activity_status }}
          
          ### ğŸ”§ å»ºè®®è§£å†³æ–¹æ¡ˆ
          1. æ£€æŸ¥ä»“åº“è®¿é—®æƒé™
          2. éªŒè¯Secretsé…ç½®
          3. æŸ¥çœ‹æœ€è¿‘çš„Actionsè¿è¡Œæ—¥å¿—
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [GitHub Actions](https://github.com/${{ github.repository }}/actions)
          - [å¥åº·æ£€æŸ¥æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *æ­¤Issueç”±GitSync-Bridgeå¥åº·æ£€æŸ¥è‡ªåŠ¨åˆ›å»º*`;
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ ‡é¢˜çš„å¼€æ”¾Issue
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            creator: 'app/github-actions'
          });
          
          const hasExisting = existingIssues.data.some(issue => 
            issue.title.includes('å¥åº·æ£€æŸ¥å‘ç°é—®é¢˜')
          );
          
          if (!hasExisting) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['ğŸš¨ health-check', 'bug']
            });
          }