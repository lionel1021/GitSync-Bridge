name: ğŸ”½ Pull from Gitee

on:
  schedule:
    - cron: '*/15 * * * *'  # æ¯15åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:

jobs:
  pull:
    runs-on: ubuntu-latest
    name: ğŸŒ‰ GitSync-Bridge from Gitee
    steps:
    - name: ğŸ“¥ Checkout GitHub repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: âš™ï¸ Setup Git Config
      run: |
        git config --global user.name "GitSync-Bridge[bot]"
        git config --global user.email "gitsync-bridge@noreply.github.com"
        
    - name: ğŸ”— Add Gitee remote and fetch
      env:
        GITEE_TOKEN: ${{ secrets.GITEE_PASSWORD }}
        GITEE_USERNAME: ${{ vars.GITEE_USERNAME }}
        GITEE_REPO: ${{ vars.GITEE_REPO }}
      run: |
        # æ·»åŠ Giteeè¿œç¨‹ä»“åº“
        git remote add gitee https://${GITEE_USERNAME}:${GITEE_TOKEN}@gitee.com/${GITEE_USERNAME}/${GITEE_REPO}.git || true
        
        # è·å–Giteeæœ€æ–°ä»£ç 
        git fetch gitee main
        
    - name: ğŸ” Check for differences
      id: check_diff
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰å·®å¼‚
        if git diff --quiet HEAD gitee/main; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“„ æ²¡æœ‰å‘ç°æ–°çš„æ›´æ”¹"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ”„ å‘ç°Giteeæœ‰æ–°çš„æ›´æ”¹ï¼Œå‡†å¤‡åŒæ­¥"
          
          # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
          echo "ğŸ“Š å˜æ›´æ‘˜è¦:"
          git log --oneline HEAD..gitee/main | head -5
        fi
        
    - name: ğŸ”„ Merge and push changes
      if: steps.check_diff.outputs.has_changes == 'true'
      run: |
        # åˆå¹¶Giteeçš„æ›´æ”¹
        git merge gitee/main --no-edit -m "ğŸŒ‰ GitSync-Bridge: è‡ªåŠ¨åŒæ­¥æ¥è‡ªGiteeçš„æ›´æ”¹ ($(date))"
        
        # æ¨é€åˆ°GitHub
        git push origin main
        
        echo "âœ… æˆåŠŸåŒæ­¥Giteeæ›´æ”¹åˆ°GitHub"
        
    - name: ğŸ“Š Log sync status
      run: |
        echo "ğŸŒ‰ GitSync-Bridge åŒæ­¥çŠ¶æ€æŠ¥å‘Š"
        echo "=================================="
        echo "ğŸ•’ åŒæ­¥æ—¶é—´: $(date)"
        echo "ğŸ“¦ GitHubä»“åº“: ${{ github.repository }}"
        echo "ğŸ“¦ Giteeä»“åº“: ${{ vars.GITEE_USERNAME }}/${{ vars.GITEE_REPO }}"
        echo "ğŸ”„ æ˜¯å¦æœ‰æ›´æ”¹: ${{ steps.check_diff.outputs.has_changes }}"
        echo "âœ… åŒæ­¥å®Œæˆ"
        
    - name: ğŸ“§ Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ GitSync-Bridge åŒæ­¥å¤±è´¥',
            body: `## ğŸš¨ åŒæ­¥å¤±è´¥æŠ¥å‘Š
            
            **æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
            **æ–¹å‘**: Gitee â†’ GitHub
            **å·¥ä½œæµ**: ${{ github.workflow }}
            **è¿è¡ŒID**: ${{ github.run_id }}
            
            è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
            
            [æŸ¥çœ‹æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
          });