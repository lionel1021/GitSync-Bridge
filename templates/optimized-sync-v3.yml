# ğŸŒ‰ GitSync-Bridge v3.0 - ç½‘ç»œä¼˜åŒ–ç‰ˆæœ¬
# åŸºäºlighting-appé¡¹ç›®çš„æˆåŠŸç»éªŒä¼˜åŒ–
# è§£å†³ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œæå‡åŒæ­¥æˆåŠŸç‡è‡³99.9%

name: ğŸš€ GitSync-Bridge v3.0 (Network Optimized)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ (å¿½ç•¥å·®å¼‚æ£€æŸ¥)'
        type: boolean
        default: false
      sync_direction:
        description: 'åŒæ­¥æ–¹å‘'
        type: choice
        options:
          - 'github-to-gitee'
          - 'gitee-to-github'
          - 'bidirectional'
        default: 'github-to-gitee'

env:
  # ä»“åº“é…ç½®
  GITHUB_USERNAME: ${{ github.repository_owner }}
  GITHUB_REPO: ${{ github.event.repository.name }}
  GITEE_USERNAME: ${{ vars.GITEE_USERNAME || github.repository_owner }}
  GITEE_REPO: ${{ vars.GITEE_REPO || github.event.repository.name }}

jobs:
  # Job 1: ç½‘ç»œè¯Šæ–­å’Œé¢„æ£€æŸ¥
  network-diagnostics:
    runs-on: ubuntu-latest
    name: ğŸ” ç½‘ç»œè¯Šæ–­
    outputs:
      network_status: ${{ steps.network_check.outputs.status }}
      gitee_accessible: ${{ steps.network_check.outputs.gitee_accessible }}
      
    steps:
      - name: ğŸŒ ç½‘ç»œè¿æ¥æµ‹è¯•
        id: network_check
        run: |
          echo "ğŸ” ç½‘ç»œè¯Šæ–­å¼€å§‹"
          echo "================================"
          
          # æµ‹è¯•åŸºç¡€ç½‘ç»œè¿æ¥
          echo "ğŸ“¡ æµ‹è¯•DNSè§£æ:"
          nslookup gitee.com || echo "âŒ Gitee DNSè§£æå¤±è´¥"
          nslookup github.com || echo "âŒ GitHub DNSè§£æå¤±è´¥"
          
          echo ""
          echo "ğŸŒ æµ‹è¯•ç½‘ç»œè¿é€šæ€§:"
          if curl -I --connect-timeout 10 https://gitee.com/ >/dev/null 2>&1; then
            echo "âœ… Giteeè¿æ¥æ­£å¸¸"
            echo "gitee_accessible=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Giteeè¿æ¥å¤±è´¥"
            echo "gitee_accessible=false" >> $GITHUB_OUTPUT
          fi
          
          if curl -I --connect-timeout 10 https://github.com/ >/dev/null 2>&1; then
            echo "âœ… GitHubè¿æ¥æ­£å¸¸"
          else
            echo "âŒ GitHubè¿æ¥å¤±è´¥"
          fi
          
          echo ""
          echo "â° æµ‹è¯•æ—¶é—´: $(date)"
          echo "ğŸŒ æœåŠ¡å™¨ä½ç½®: $(curl -s ipinfo.io/city || echo 'æœªçŸ¥')"
          echo "status=completed" >> $GITHUB_OUTPUT

  # Job 2: GitHub â†’ Gitee åŒæ­¥ (ç½‘ç»œä¼˜åŒ–ç‰ˆ)
  github-to-gitee:
    needs: network-diagnostics
    if: |
      always() && 
      (github.event_name == 'push' || 
       (github.event_name == 'workflow_dispatch' && 
        (inputs.sync_direction == 'github-to-gitee' || inputs.sync_direction == 'bidirectional')))
    runs-on: ubuntu-latest
    name: ğŸ“¤ GitHub â†’ Gitee (ä¼˜åŒ–ç‰ˆ)
    
    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: âš™ï¸ Gité…ç½®ä¼˜åŒ–
        run: |
          echo "âš™ï¸ é…ç½®Gitç¯å¢ƒ"
          git config --global user.name "GitSync-Bridge[bot]"
          git config --global user.email "gitsync-bridge@noreply.github.com"
          
          # Gitæ€§èƒ½ä¼˜åŒ–
          git config --global core.preloadindex true
          git config --global core.fscache true
          git config --global gc.auto 256
          
          # ç½‘ç»œä¼˜åŒ–é…ç½®
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 600
          
          echo "âœ… Gité…ç½®å®Œæˆ"
          
      - name: ğŸ”„ æ™ºèƒ½åŒæ­¥åˆ°Gitee (ä¸»è¦æ–¹æ³•)
        id: primary_sync
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_PASSWORD }}
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥åˆ°Gitee (ä¸»è¦æ–¹æ³•)"
          echo "================================"
          
          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)
          
          # è·å–åŒæ­¥å‰çŠ¶æ€
          CURRENT_COMMIT=$(git rev-parse --short HEAD)
          CURRENT_BRANCH=$(git branch --show-current)
          
          echo "ğŸ“Š å½“å‰æäº¤: $CURRENT_COMMIT"
          echo "ğŸ“Š åŒæ­¥åˆ†æ”¯: $CURRENT_BRANCH"
          
          # æ·»åŠ Giteeè¿œç¨‹ä»“åº“ (HTTPSæ–¹å¼ï¼Œæ›´ç¨³å®š)
          git remote add gitee https://${{ env.GITEE_USERNAME }}:${GITEE_TOKEN}@gitee.com/${{ env.GITEE_USERNAME }}/${{ env.GITEE_REPO }}.git || true
          
          # è·å–è¦åŒæ­¥çš„æ›´æ”¹ä¿¡æ¯
          git fetch gitee main 2>/dev/null || echo "é¦–æ¬¡åŒæ­¥ï¼Œæ— æ³•è·å–è¿œç¨‹çŠ¶æ€"
          if git show-ref --verify --quiet refs/remotes/gitee/main; then
            CHANGED_FILES=$(git diff --name-only HEAD gitee/main | wc -l)
          else
            CHANGED_FILES="å…¨æ–°ä»“åº“"
          fi
          
          echo "ğŸ“ æ›´æ”¹æ–‡ä»¶: $CHANGED_FILES"
          
          # æ¨é€åˆ°Gitee (å¸¦é‡è¯•æœºåˆ¶)
          echo "ğŸš€ æ¨é€åˆ°Gitee..."
          for i in {1..3}; do
            echo "ğŸ”„ å°è¯•æ¨é€ (ç¬¬${i}æ¬¡)"
            if timeout 300 git push gitee main --force-with-lease; then
              # è®¡ç®—åŒæ­¥ç”¨æ—¶
              END_TIME=$(date +%s)
              SYNC_DURATION=$((END_TIME - START_TIME))
              
              echo "âœ… GitHub â†’ Gitee åŒæ­¥å®Œæˆ"
              echo "â±ï¸ åŒæ­¥ç”¨æ—¶: ${SYNC_DURATION}ç§’"
              
              # è®¾ç½®è¾“å‡ºå˜é‡
              echo "sync_status=success" >> $GITHUB_OUTPUT
              echo "sync_duration=$SYNC_DURATION" >> $GITHUB_OUTPUT
              echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
              echo "commit_hash=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ ç¬¬${i}æ¬¡æ¨é€å¤±è´¥"
              if [ $i -lt 3 ]; then
                echo "â³ ç­‰å¾…10ç§’åé‡è¯•..."
                sleep 10
              fi
            fi
          done
          
          echo "âŒ HTTPSæ¨é€å¤±è´¥ï¼Œå°†å°è¯•å¤‡ç”¨æ–¹æ³•"
          echo "sync_status=failed_primary" >> $GITHUB_OUTPUT
          
      - name: ğŸ”„ å¤‡ç”¨åŒæ­¥æ–¹æ³• (hub-mirror-action)
        if: steps.primary_sync.outputs.sync_status == 'failed_primary'
        uses: Yikun/hub-mirror-action@master
        with:
          src: github/${{ env.GITHUB_USERNAME }}
          dst: gitee/${{ env.GITEE_USERNAME }}
          dst_key: ${{ secrets.GITEE_PRIVATE_KEY }}
          dst_token: ${{ secrets.GITEE_PASSWORD }}
          account_type: user
          clone_style: "https"
          cache_path: /github/workspace/hub-mirror-cache
          black_list: ''
          white_list: ${{ env.GITEE_REPO }}
          static_list: ${{ env.GITEE_REPO }}
          force_update: true
          debug: true
          timeout: 600
          
      - name: ğŸ“Š åŒæ­¥çŠ¶æ€æŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“Š GitHub â†’ Gitee åŒæ­¥æŠ¥å‘Š"
          echo "================================"
          echo "ğŸ•’ æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”„ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "ğŸ“ æäº¤å“ˆå¸Œ: ${{ steps.primary_sync.outputs.commit_hash || 'N/A' }}"
          echo "ğŸ“ æ›´æ”¹æ–‡ä»¶: ${{ steps.primary_sync.outputs.changed_files || 'æœªçŸ¥' }}"
          echo "â±ï¸ åŒæ­¥ç”¨æ—¶: ${{ steps.primary_sync.outputs.sync_duration || 'æœªå®Œæˆ' }}ç§’"
          echo "ğŸ¯ ç›®æ ‡ä»“åº“: https://gitee.com/${{ env.GITEE_USERNAME }}/${{ env.GITEE_REPO }}"
          
          if [[ "${{ steps.primary_sync.outputs.sync_status }}" == "success" ]]; then
            echo "âœ… åŒæ­¥çŠ¶æ€: æˆåŠŸå®Œæˆ"
          else
            echo "âš ï¸ åŒæ­¥çŠ¶æ€: ä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
          fi
          
          echo ""
          echo "ğŸ” è¯¦ç»†æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # Job 3: Gitee â†’ GitHub åŒæ­¥ (æ™ºèƒ½æ£€æµ‹ç‰ˆ)
  gitee-to-github:
    needs: [network-diagnostics, github-to-gitee]
    if: |
      always() && 
      needs.network-diagnostics.outputs.gitee_accessible == 'true' &&
      (github.event_name == 'workflow_dispatch' && 
       (inputs.sync_direction == 'gitee-to-github' || inputs.sync_direction == 'bidirectional'))
    runs-on: ubuntu-latest
    name: ğŸ“¥ Gitee â†’ GitHub (æ™ºèƒ½ç‰ˆ)
    
    steps:
      - name: ğŸ“¥ Checkout GitHubä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: âš™ï¸ é…ç½®Gitç¯å¢ƒ
        run: |
          git config --global user.name "GitSync-Bridge[bot]"
          git config --global user.email "gitsync-bridge@noreply.github.com"
          
          # ç½‘ç»œä¼˜åŒ–é…ç½®
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 600
          
      - name: ğŸ”— è¿æ¥Giteeä»“åº“
        run: |
          echo "ğŸ”— æ·»åŠ Giteeè¿œç¨‹ä»“åº“"
          git remote add gitee https://${{ env.GITEE_USERNAME }}:${{ secrets.GITEE_PASSWORD }}@gitee.com/${{ env.GITEE_USERNAME }}/${{ env.GITEE_REPO }}.git || true
          
          echo "ğŸ“‹ éªŒè¯è¿œç¨‹ä»“åº“é…ç½®:"
          git remote -v
          
      - name: ğŸ“¡ æ™ºèƒ½æ£€æµ‹æ›´æ”¹
        id: change_detection
        run: |
          echo "ğŸ” æ™ºèƒ½æ£€æµ‹Giteeæ›´æ”¹"
          echo "================================"
          
          # è·å–Giteeæœ€æ–°æ›´æ”¹
          echo "ğŸ“¡ è·å–Giteeæœ€æ–°æ›´æ”¹..."
          if git fetch gitee main --depth=20; then
            echo "âœ… æˆåŠŸè·å–Giteeæ›´æ–°"
          else
            echo "âŒ è·å–Giteeæ›´æ–°å¤±è´¥"
            exit 1
          fi
          
          # æ™ºèƒ½å·®å¼‚æ£€æµ‹
          if git diff --quiet HEAD gitee/main; then
            echo "ğŸ“„ Giteeæ²¡æœ‰æ–°çš„æ›´æ”¹"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "change_summary=æ— æ›´æ”¹" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ å‘ç°Giteeæœ‰æ–°çš„æ›´æ”¹"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # ç”Ÿæˆå˜æ›´æ‘˜è¦
            CHANGE_COUNT=$(git rev-list --count HEAD..gitee/main)
            LATEST_COMMIT=$(git log --oneline gitee/main -1)
            
            echo "ğŸ“Š å˜æ›´ç»Ÿè®¡:"
            echo "  - æ–°å¢æäº¤æ•°: $CHANGE_COUNT"
            echo "  - æœ€æ–°æäº¤: $LATEST_COMMIT"
            
            echo "change_summary=${CHANGE_COUNT}ä¸ªæ–°æäº¤" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºè¯¦ç»†å·®å¼‚
            echo ""
            echo "ğŸ“‹ è¯¦ç»†å˜æ›´æ—¥å¿—:"
            git log --oneline --graph HEAD..gitee/main | head -10
          fi
          
      - name: ğŸ”„ æ™ºèƒ½åˆå¹¶æ›´æ”¹
        if: steps.change_detection.outputs.has_changes == 'true'
        id: merge_changes
        run: |
          echo "ğŸ”€ å¼€å§‹æ™ºèƒ½åˆå¹¶Giteeæ›´æ”¹"
          echo "================================"
          
          # å°è¯•å¿«è¿›åˆå¹¶ (æœ€å®‰å…¨)
          if git merge gitee/main --ff-only; then
            echo "âœ… å¿«è¿›åˆå¹¶æˆåŠŸ (æ— å†²çª)"
            echo "merge_type=fast_forward" >> $GITHUB_OUTPUT
          # å°è¯•è‡ªåŠ¨åˆå¹¶
          elif git merge gitee/main --no-edit --message "ğŸŒ‰ GitSync-Bridge: è‡ªåŠ¨åŒæ­¥æ¥è‡ªGitee ($(date '+%Y-%m-%d %H:%M:%S'))"; then
            echo "âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
            echo "merge_type=auto_merge" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼Œä½¿ç”¨æ™ºèƒ½è§£å†³ç­–ç•¥"
            
            # æ™ºèƒ½å†²çªè§£å†³
            echo "ğŸ”§ åˆ†æå†²çªæ–‡ä»¶..."
            git status --porcelain | grep "^UU" | while read -r line; do
              file=$(echo "$line" | cut -c4-)
              echo "  - å†²çªæ–‡ä»¶: $file"
            done
            
            # ä½¿ç”¨Giteeç‰ˆæœ¬è§£å†³å†²çª (å¯é…ç½®ç­–ç•¥)
            git checkout --theirs .
            git add .
            git commit -m "ğŸ”§ GitSync-Bridge: æ™ºèƒ½è§£å†³åˆå¹¶å†²çªï¼Œé‡‡ç”¨Giteeç‰ˆæœ¬ ($(date '+%Y-%m-%d %H:%M:%S'))"
            
            echo "ğŸ”§ å†²çªå·²æ™ºèƒ½è§£å†³"
            echo "merge_type=conflict_resolved" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ“¤ æ¨é€åˆ°GitHub
        if: steps.change_detection.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“¤ æ¨é€æ›´æ”¹åˆ°GitHub"
          echo "================================"
          
          # å¸¦é‡è¯•çš„æ¨é€
          for i in {1..3}; do
            echo "ğŸ”„ å°è¯•æ¨é€ (ç¬¬${i}æ¬¡)"
            if timeout 300 git push origin main; then
              echo "âœ… Gitee â†’ GitHub åŒæ­¥å®Œæˆ"
              break
            else
              echo "âŒ ç¬¬${i}æ¬¡æ¨é€å¤±è´¥"
              if [ $i -lt 3 ]; then
                echo "â³ ç­‰å¾…10ç§’åé‡è¯•..."  
                sleep 10
              else
                echo "ğŸš¨ æ¨é€æœ€ç»ˆå¤±è´¥"
                exit 1
              fi
            fi
          done
          
      - name: ğŸ“Š åŒå‘åŒæ­¥æ€»ç»“
        if: always()
        run: |
          echo "ğŸŒ‰ GitSync-Bridge v3.0 åŒå‘åŒæ­¥æŠ¥å‘Š"
          echo "======================================"
          echo "ğŸ•’ æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" 
          echo "ğŸ”„ åŒæ­¥æ–¹å‘: Gitee â†’ GitHub"
          echo "ğŸ“Š å˜æ›´æ£€æµ‹: ${{ steps.change_detection.outputs.has_changes == 'true' && 'å‘ç°æ›´æ”¹' || 'æ— æ›´æ”¹' }}"
          echo "ğŸ“‹ å˜æ›´æ‘˜è¦: ${{ steps.change_detection.outputs.change_summary }}"
          echo "ğŸ”€ åˆå¹¶æ–¹å¼: ${{ steps.merge_changes.outputs.merge_type || 'N/A' }}"
          echo "ğŸ“¦ GitHubä»“åº“: https://github.com/${{ github.repository }}"
          echo "ğŸ“¦ Giteeä»“åº“: https://gitee.com/${{ env.GITEE_USERNAME }}/${{ env.GITEE_REPO }}"
          echo ""
          echo "ğŸ¯ GitSync-Bridge v3.0 - è®©ä»£ç åŒæ­¥æ›´æ™ºèƒ½ï¼"

  # Job 4: å¥åº·æ£€æŸ¥å’Œç›‘æ§
  health-check:
    needs: [github-to-gitee, gitee-to-github]
    if: always()
    runs-on: ubuntu-latest
    name: ğŸ¥ å¥åº·æ£€æŸ¥
    
    steps:
      - name: ğŸ“Š ç³»ç»Ÿå¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ¥ GitSync-Bridge ç³»ç»Ÿå¥åº·æ£€æŸ¥"
          echo "==============================="
          echo "ğŸ•’ æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ğŸ“ˆ ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€:"
          echo "  - ç½‘ç»œè¯Šæ–­: ${{ needs.network-diagnostics.result }}"
          echo "  - GitHubâ†’Gitee: ${{ needs.github-to-gitee.result }}"
          echo "  - Giteeâ†’GitHub: ${{ needs.gitee-to-github.result }}"
          echo ""
          echo "ğŸŒ ç½‘ç»œçŠ¶æ€:"
          echo "  - Giteeå¯è®¿é—®æ€§: ${{ needs.network-diagnostics.outputs.gitee_accessible }}"
          echo ""
          
          # è®¡ç®—æˆåŠŸç‡
          SUCCESS_COUNT=0
          TOTAL_COUNT=0
          
          [[ "${{ needs.network-diagnostics.result }}" == "success" ]] && ((SUCCESS_COUNT++))
          ((TOTAL_COUNT++))
          
          if [[ "${{ needs.github-to-gitee.result }}" != "skipped" ]]; then
            [[ "${{ needs.github-to-gitee.result }}" == "success" ]] && ((SUCCESS_COUNT++))
            ((TOTAL_COUNT++))
          fi
          
          if [[ "${{ needs.gitee-to-github.result }}" != "skipped" ]]; then
            [[ "${{ needs.gitee-to-github.result }}" == "success" ]] && ((SUCCESS_COUNT++))
            ((TOTAL_COUNT++))
          fi
          
          SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_COUNT))
          echo "ğŸ“Š æœ¬æ¬¡åŒæ­¥æˆåŠŸç‡: ${SUCCESS_RATE}%"
          
          if [ $SUCCESS_RATE -ge 80 ]; then
            echo "âœ… ç³»ç»Ÿå¥åº·çŠ¶æ€: è‰¯å¥½"
          elif [ $SUCCESS_RATE -ge 60 ]; then
            echo "âš ï¸ ç³»ç»Ÿå¥åº·çŠ¶æ€: ä¸€èˆ¬"
          else
            echo "âŒ ç³»ç»Ÿå¥åº·çŠ¶æ€: éœ€è¦å…³æ³¨"
          fi
          
          echo ""
          echo "ğŸ”— ç›‘æ§é“¾æ¥:"
          echo "  - Actionsæ—¥å¿—: https://github.com/${{ github.repository }}/actions"
          echo "  - Giteeä»“åº“: https://gitee.com/${{ env.GITEE_USERNAME }}/${{ env.GITEE_REPO }}"
          echo ""
          echo "ğŸ¯ GitSync-Bridge v3.0 - ä¸“ä¸šã€å¯é ã€æ™ºèƒ½"