# ğŸŒ‰ GitSync-Bridge åŸºç¡€åŒæ­¥æ¨¡æ¿
# é€‚ç”¨äºå¤§å¤šæ•°é¡¹ç›®çš„ç®€å•åŒå‘åŒæ­¥é…ç½®

name: ğŸ”„ Basic Sync

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # é…ç½®ç¯å¢ƒå˜é‡ (è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹)
  GITHUB_USERNAME: ${{ github.repository_owner }}
  GITHUB_REPO: ${{ github.event.repository.name }}
  GITEE_USERNAME: ${{ vars.GITEE_USERNAME }}  # åœ¨Repository Variablesä¸­é…ç½®
  GITEE_REPO: ${{ vars.GITEE_REPO }}          # åœ¨Repository Variablesä¸­é…ç½®

jobs:
  # Job 1: GitHub â†’ Gitee åŒæ­¥
  github-to-gitee:
    if: github.event_name == 'push'  # åªåœ¨pushæ—¶è§¦å‘
    runs-on: ubuntu-latest
    name: ğŸ“¤ GitHub to Gitee
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
        
    - name: ğŸ”„ Mirror to Gitee
      uses: Yikun/hub-mirror-action@master
      with:
        src: github/${{ env.GITHUB_USERNAME }}/${{ env.GITHUB_REPO }}
        dst: gitee/${{ env.GITEE_USERNAME }}/${{ env.GITEE_REPO }}
        dst_key: ${{ secrets.GITEE_PRIVATE_KEY }}
        dst_token: ${{ secrets.GITEE_PASSWORD }}
        force_update: true
        debug: false  # ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­debug
        timeout: 600  # 10åˆ†é’Ÿè¶…æ—¶
        
    - name: âœ… Sync completed
      run: |
        echo "ğŸ‰ GitHub â†’ Gitee åŒæ­¥å®Œæˆ"
        echo "ğŸ“Š åŒæ­¥æ—¶é—´: $(date)"
        echo "ğŸ“¦ æºä»“åº“: https://github.com/${{ env.GITHUB_USERNAME }}/${{ env.GITHUB_REPO }}"
        echo "ğŸ“¦ ç›®æ ‡ä»“åº“: https://gitee.com/${{ env.GITEE_USERNAME }}/${{ env.GITEE_REPO }}"

  # Job 2: å®šæ—¶ä»Giteeæ‹‰å–æ›´æ–°
  gitee-to-github:
    runs-on: ubuntu-latest
    name: ğŸ“¥ Gitee to GitHub
    # åªåœ¨å®šæ—¶è§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Checkout GitHub repository  
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: âš™ï¸ Configure Git
      run: |
        git config --global user.name "GitSync-Bridge[bot]"
        git config --global user.email "gitsync-bridge@noreply.github.com"
        
    - name: ğŸ”— Add Gitee remote
      run: |
        # æ·»åŠ Giteeè¿œç¨‹ä»“åº“
        git remote add gitee https://${{ env.GITEE_USERNAME }}:${{ secrets.GITEE_PASSWORD }}@gitee.com/${{ env.GITEE_USERNAME }}/${{ env.GITEE_REPO }}.git || true
        
        # éªŒè¯è¿œç¨‹ä»“åº“
        git remote -v
        
    - name: ğŸ“¡ Fetch from Gitee
      run: |
        echo "ğŸ”„ ä»Giteeè·å–æœ€æ–°æ›´æ”¹..."
        git fetch gitee main --depth=10  # è·å–æœ€è¿‘10ä¸ªæäº¤
        
    - name: ğŸ” Check for differences
      id: diff_check
      run: |
        # æ¯”è¾ƒæœ¬åœ°å’Œè¿œç¨‹çš„å·®å¼‚
        if git diff --quiet HEAD gitee/main; then
          echo "ğŸ“„ æ²¡æœ‰å‘ç°æ–°çš„æ›´æ”¹"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ”„ å‘ç°Giteeæœ‰æ–°çš„æ›´æ”¹ï¼Œå‡†å¤‡åŒæ­¥"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºå·®å¼‚æ‘˜è¦
          echo "ğŸ“Š å˜æ›´æ‘˜è¦:"
          git log --oneline --graph HEAD..gitee/main | head -10
        fi
        
    - name: ğŸ”„ Merge changes
      if: steps.diff_check.outputs.has_changes == 'true'
      run: |
        echo "ğŸ”€ åˆå¹¶Giteeçš„æ›´æ”¹..."
        
        # å°è¯•è‡ªåŠ¨åˆå¹¶
        if git merge gitee/main --no-edit --message "ğŸŒ‰ GitSync-Bridge: è‡ªåŠ¨åŒæ­¥æ¥è‡ªGiteeçš„æ›´æ”¹ ($(date))"; then
          echo "âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
        else
          echo "âš ï¸ æ£€æµ‹åˆ°åˆå¹¶å†²çª"
          
          # ç®€å•çš„å†²çªè§£å†³ç­–ç•¥ï¼šä½¿ç”¨Giteeç‰ˆæœ¬
          git checkout --theirs .
          git add .
          git commit -m "ğŸ”§ GitSync-Bridge: è§£å†³åˆå¹¶å†²çªï¼Œä½¿ç”¨Giteeç‰ˆæœ¬ ($(date))"
          
          echo "ğŸ”§ å†²çªå·²è‡ªåŠ¨è§£å†³"
        fi
        
    - name: ğŸ“¤ Push to GitHub
      if: steps.diff_check.outputs.has_changes == 'true'
      run: |
        echo "ğŸ“¤ æ¨é€æ›´æ”¹åˆ°GitHub..."
        git push origin main
        echo "âœ… Gitee â†’ GitHub åŒæ­¥å®Œæˆ"
        
    - name: ğŸ“Š Sync report
      run: |
        echo "ğŸŒ‰ GitSync-Bridge åŒæ­¥æŠ¥å‘Š"
        echo "=========================="
        echo "ğŸ•’ æ‰§è¡Œæ—¶é—´: $(date)"
        echo "ğŸ”„ åŒæ­¥çŠ¶æ€: ${{ steps.diff_check.outputs.has_changes == 'true' && 'æœ‰æ›´æ”¹å·²åŒæ­¥' || 'æ— æ›´æ”¹éœ€è¦åŒæ­¥' }}"
        echo "ğŸ“¦ GitHubä»“åº“: ${{ github.repository }}"
        echo "ğŸ“¦ Giteeä»“åº“: ${{ env.GITEE_USERNAME }}/${{ env.GITEE_REPO }}"

# å®šæ—¶ä»»åŠ¡é…ç½® (æ·»åŠ åˆ°å•ç‹¬çš„workflowæ–‡ä»¶ä¸­)
---
name: ğŸ•’ Scheduled Sync

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  scheduled-pull:
    uses: ./.github/workflows/basic-sync.yml  # è°ƒç”¨åŸºç¡€åŒæ­¥workflow
    secrets: inherit
    with:
      sync_direction: "gitee-to-github"